<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>9포인트 정밀 시야각 측정</title>
    <style>
        body { background-color: #000; color: #fff; margin: 0; overflow: hidden; font-family: sans-serif; }
        #canvas { width: 100vw; height: 100vh; display: block; }
        .ui-layer { position: absolute; top: 20px; left: 20px; background: rgba(30,30,30,0.9); padding: 15px; border-radius: 8px; border: 1px solid #444; }
        .control-panel { position: absolute; bottom: 20px; right: 20px; }
        button { cursor: pointer; padding: 10px 20px; background: #00ffcc; border: none; font-weight: bold; border-radius: 5px; }
        #status { color: #ffeb3b; font-size: 1.1rem; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="ui-layer">
        <h3>정밀 시야각 테스트 (9 Points)</h3>
        <div id="instruction">현재 주시할 점: <span id="target-id" style="color:red; font-size:1.5rem;">준비</span></div>
        <p>1. <b style="color:red">빨간색 주시점</b>을 끝까지 응시하세요.</p>
        <p>2. 흰 점이 주변시로 보이는 순간 <b>[스페이스바]</b>!</p>
        <div id="status">대기 중...</div>
    </div>

    <div class="control-panel">
        <button onclick="startFullTest()">9포인트 전수 측정 시작</button>
        <button onclick="copyData()">데이터 복사</button>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        const targetIdDisplay = document.getElementById('target-id');
        
        let width, height;
        let testActive = false;
        let currentPIdx = 0; // P1 ~ P9
        let currentAngleIdx = 0; // 0, 90, 180, 270도
        let results = {};

        const focusPoints = [
            {id: "P1", x: 5, y: 5}, {id: "P2", x: 50, y: 5}, {id: "P3", x: 95, y: 5},
            {id: "P4", x: 5, y: 50}, {id: "P5", x: 50, y: 50}, {id: "P6", x: 95, y: 50},
            {id: "P7", x: 5, y: 95}, {id: "P8", x: 50, y: 95}, {id: "P9", x: 95, y: 95}
        ];
        const angles = [0, 90, 180, 270]; // 동서남북 4방향 (필요시 추가 가능)
        let stimulus = { x: 0, y: 0, dist: 0, active: false };

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            draw();
        }
        window.addEventListener('resize', resize);
        resize();

        function draw() {
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, width, height);

            // 1. 모든 가이드 포인트 반투명하게 표시
            focusPoints.forEach(p => {
                ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';
                ctx.beginPath();
                ctx.arc(width * p.x/100, height * p.y/100, 5, 0, Math.PI*2);
                ctx.fill();
            });

            if (!testActive && currentPIdx === 0) return;

            // 2. 현재 주시해야 할 빨간 점 강하게 표시
            const cp = focusPoints[currentPIdx];
            const curX = width * cp.x/100;
            const curY = height * cp.y/100;
            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.arc(curX, curY, 10, 0, Math.PI*2);
            ctx.fill();
            targetIdDisplay.innerText = cp.id;

            // 3. 탐색 점 (Stimulus) - 이동 속도를 늦추기 위해 dist 감소폭 조절
            if (stimulus.active) {
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(stimulus.x, stimulus.y, 6, 0, Math.PI*2);
                ctx.fill();
            }
        }

        function startFullTest() {
            results = {};
            currentPIdx = 0;
            currentAngleIdx = 0;
            testActive = true;
            nextStep();
        }

        function nextStep() {
            if (currentPIdx >= focusPoints.length) {
                testActive = false;
                stimulus.active = false;
                status.innerText = "모든 측정 완료!";
                draw();
                return;
            }

            if (currentAngleIdx >= angles.length) {
                currentAngleIdx = 0;
                currentPIdx++;
                setTimeout(nextStep, 1500); // 다음 포인트 이동 전 휴식
                return;
            }

            const angle = angles[currentAngleIdx] * (Math.PI / 180);
            stimulus.dist = Math.max(width, height) * 0.4; // 탐색 시작 거리
            stimulus.active = true;
            status.innerText = `${focusPoints[currentPIdx].id} 측정 중... (${angles[currentAngleIdx]}도)`;
            animate();
        }

        function animate() {
            if (!stimulus.active || !testActive) return;

            const cp = focusPoints[currentPIdx];
            const curX = width * cp.x/100;
            const curY = height * cp.y/100;
            const angle = angles[currentAngleIdx] * (Math.PI / 180);

            stimulus.dist -= 1.5; // 속도 대폭 감소 (1.5px per frame)
            stimulus.x = curX + Math.cos(angle) * stimulus.dist;
            stimulus.y = curY + Math.sin(angle) * stimulus.dist;

            draw();

            if (stimulus.dist <= 0) {
                recordPoint(curX, curY);
            } else {
                requestAnimationFrame(animate);
            }
        }

        function recordPoint(x, y) {
            const pid = focusPoints[currentPIdx].id;
            if (!results[pid]) results[pid] = [];
            
            results[pid].push({
                angle: angles[currentAngleIdx],
                dist: stimulus.dist.toFixed(1)
            });
            
            stimulus.active = false;
            currentAngleIdx++;
            nextStep();
        }

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && stimulus.active) {
                e.preventDefault();
                recordPoint(stimulus.x, stimulus.y);
            }
        });

        function copyData() {
            const dataStr = JSON.stringify(results);
            navigator.clipboard.writeText(dataStr);
            alert("데이터가 복사되었습니다. AI에게 전달하세요!");
        }
    </script>
</body>
</html>
