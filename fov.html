<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>실전 압축형 9포인트 FOV</title>
    <style>
        body { background-color: #000; color: #fff; margin: 0; overflow: hidden; font-family: sans-serif; }
        #canvas { width: 100vw; height: 100vh; display: block; cursor: none; }
        #admin-layer { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: rgba(30, 30, 30, 0.95); padding: 35px; border-radius: 20px; 
            border: 2px solid #00ffcc; text-align: center; z-index: 100;
        }
        .admin-btn { 
            cursor: pointer; padding: 15px 40px; background: #00ffcc; border: none; 
            font-weight: bold; border-radius: 8px; font-size: 1.1em; color: #000;
        }
    </style>
</head>
<body>
    <div id="admin-layer">
        <h2 style="color:#00ffcc; margin-top:0;">실전 압축 시야 측정 (32회)</h2>
        <p style="text-align:left; font-size:0.9em; line-height:1.6;">
            - 빨간 점 응시, 흰 점 보이면 <b>[스페이스바]</b><br>
            - 중앙은 8방향, 외곽은 핵심 3방향씩만 측정합니다.<br>
            - 관찰자가 마우스로 클릭하면 시작합니다.
        </p>
        <button class="admin-btn" onclick="startTest()">측정 시작</button>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const adminLayer = document.getElementById('admin-layer');
        
        let width, height, testActive = false;
        let currentPIdx = 0, currentAngleIdx = 0, results = {};

        // 0:우, 45:우상, 90:상, 135:좌상, 180:좌, 225:좌하, 270:하, 315:우하
        const focusPoints = [
            {id: "P1", x: 5, y: 5,   angles: [0, 315, 270]},      // 우, 우하, 하
            {id: "P2", x: 50, y: 5,  angles: [180, 270, 0]},      // 좌, 하, 우
            {id: "P3", x: 95, y: 5,  angles: [180, 225, 270]},    // 좌, 좌하, 하
            {id: "P4", x: 5, y: 50,  angles: [90, 0, 270]},       // 상, 우, 하
            {id: "P5", x: 50, y: 50, angles: [0, 45, 90, 135, 180, 225, 270, 315]}, // 정밀
            {id: "P6", x: 95, y: 50, angles: [90, 180, 270]},     // 상, 좌, 하
            {id: "P7", x: 5, y: 95,  angles: [0, 45, 90]},        // 우, 우상, 상
            {id: "P8", x: 50, y: 95, angles: [180, 90, 0]},       // 좌, 상, 우
            {id: "P9", x: 95, y: 95, angles: [180, 135, 90]}      // 좌, 좌상, 상
        ];

        let stimulus = { x: 0, y: 0, dist: 0, active: false };
        let moveTimer;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            draw();
        }
        window.addEventListener('resize', resize);
        resize();

        function draw() {
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, width, height);
            if (!testActive) return;

            const cp = focusPoints[currentPIdx];
            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.arc(width * cp.x/100, height * cp.y/100, 8, 0, Math.PI*2);
            ctx.fill();

            if (stimulus.active) {
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(stimulus.x, stimulus.y, 6, 0, Math.PI*2);
                ctx.fill();
            }
        }

        function startTest() {
            adminLayer.style.display = 'none';
            results = {}; currentPIdx = 0; currentAngleIdx = 0;
            testActive = true;
            nextStep();
        }

        function nextStep() {
            if (currentPIdx >= focusPoints.length) {
                finishTest(); return;
            }
            const cp = focusPoints[currentPIdx];
            if (currentAngleIdx >= cp.angles.length) {
                currentAngleIdx = 0; currentPIdx++;
                setTimeout(nextStep, 1500); return;
            }

            draw();
            setTimeout(() => {
                stimulus.dist = Math.max(width, height) * 0.8;
                stimulus.active = true;
                if (moveTimer) clearInterval(moveTimer);
                moveTimer = setInterval(() => {
                    stimulus.dist -= 25; 
                    const angleRad = cp.angles[currentAngleIdx] * (Math.PI / 180);
                    stimulus.x = (width * cp.x/100) + Math.cos(angleRad) * stimulus.dist;
                    stimulus.y = (height * cp.y/100) - Math.sin(angleRad) * stimulus.dist;
                    draw();
                    if (stimulus.dist <= 0) recordPoint(true);
                }, 70); 
            }, 1200); 
        }

        function recordPoint(failed = false) {
            clearInterval(moveTimer);
            const cp = focusPoints[currentPIdx];
            if (!results[cp.id]) results[cp.id] = {};
            results[cp.id][cp.angles[currentAngleIdx]] = failed ? "Blind" : stimulus.dist.toFixed(0);
            stimulus.active = false;
            currentAngleIdx++;
            draw();
            setTimeout(nextStep, 500);
        }

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && stimulus.active) {
                e.preventDefault(); recordPoint(false);
            }
        });

        function finishTest() {
            testActive = false;
            adminLayer.style.display = 'block';
            adminLayer.innerHTML = `<h2 style="color:#00ffcc;">측정 완료</h2><button class="admin-btn" onclick="copyData()">데이터 복사</button>`;
        }

        function copyData() {
            navigator.clipboard.writeText(JSON.stringify(results, null, 2));
            alert('데이터가 복사되었습니다.');
        }
    </script>
</body>
</html>
