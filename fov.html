<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>환경 최적화 시야각 측정 도구</title>
    <style>
        body { background-color: #000; color: #fff; margin: 0; overflow: hidden; font-family: sans-serif; }
        #canvas { width: 100vw; height: 100vh; display: block; }
        .ui-layer { position: absolute; top: 20px; left: 20px; background: rgba(30,30,30,0.9); padding: 15px; border-radius: 8px; border: 1px solid #444; }
        .control-panel { position: absolute; bottom: 20px; right: 20px; background: rgba(30,30,30,0.9); padding: 15px; border-radius: 8px; }
        input { background: #444; color: #fff; border: 1px solid #666; padding: 5px; width: 60px; }
        button { cursor: pointer; padding: 10px 20px; background: #00ffcc; border: none; font-weight: bold; border-radius: 5px; }
        #status { color: #ffeb3b; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="ui-layer">
        <h3>환경 보정형 FOV 테스트</h3>
        <div>
            모니터 크기(인치): <input type="number" id="monitor-size" value="27"> | 
            시청 거리(cm): <input type="number" id="view-dist" value="60">
        </div>
        <p id="status">설정 입력 후 [테스트 시작]을 누르세요.</p>
    </div>

    <div class="control-panel">
        <button onclick="startFullTest()">테스트 시작</button>
        <button onclick="copyData()">데이터 복사</button>
    </div>

    <canvas id="canvas"></canvas>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        
        let width, height, refUnit;
        let testActive = false;
        let currentPIdx = 0; 
        let currentAngleIdx = 0; 
        let results = { metadata: {}, data: {} };

        const focusPoints = [
            {id: "P1", x: 10, y: 10}, {id: "P2", x: 50, y: 10}, {id: "P3", x: 90, y: 10},
            {id: "P4", x: 10, y: 50}, {id: "P5", x: 50, y: 50}, {id: "P6", x: 90, y: 50},
            {id: "P7", x: 10, y: 90}, {id: "P8", x: 50, y: 90}, {id: "P9", x: 90, y: 90}
        ];
        const angles = [0, 90, 180, 270]; 
        let stimulus = { distPercent: 0, active: false };
        let moveTimer;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            // 해상도에 상관없는 기준 단위 (화면의 짧은 쪽을 100으로 가정)
            refUnit = Math.min(width, height) / 2;
            draw();
        }
        window.addEventListener('resize', resize);
        resize();

        function draw() {
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, width, height);
            if (!testActive) return;

            const cp = focusPoints[currentPIdx];
            const curX = width * cp.x/100;
            const curY = height * cp.y/100;

            // 주시점
            ctx.fillStyle = 'red';
            ctx.shadowBlur = 15; ctx.shadowColor = "red";
            ctx.beginPath(); ctx.arc(curX, curY, 12, 0, Math.PI*2); ctx.fill();
            ctx.shadowBlur = 0;

            // 탐색 점 (상대 좌표 계산)
            if (stimulus.active) {
                const angle = angles[currentAngleIdx] * (Math.PI / 180);
                const stimX = curX + Math.cos(angle) * (refUnit * stimulus.distPercent / 100);
                const stimY = curY + Math.sin(angle) * (refUnit * stimulus.distPercent / 100);
                
                ctx.fillStyle = 'white';
                ctx.beginPath(); ctx.arc(stimX, stimY, 8, 0, Math.PI*2); ctx.fill();
            }
        }

        function startFullTest() {
            // 메타데이터 저장 (환경 보정용)
            results.metadata = {
                screenRes: `${width}x${height}`,
                monitorSize: document.getElementById('monitor-size').value,
                viewDist: document.getElementById('view-dist').value,
                timestamp: new Date().toISOString()
            };
            results.data = {};
            currentPIdx = 0; currentAngleIdx = 0;
            testActive = true;
            nextStep();
        }

        function nextStep() {
            if (currentPIdx >= focusPoints.length) {
                testActive = false;
                status.innerText = "측정 완료! 데이터를 복사하세요.";
                draw(); return;
            }
            if (currentAngleIdx >= angles.length) {
                currentAngleIdx = 0; currentPIdx++;
                setTimeout(nextStep, 2000); return;
            }

            stimulus.distPercent = 80; // 화면 반지름의 80% 지점에서 시작
            stimulus.active = true;
            status.innerText = `${focusPoints[currentPIdx].id} 응시 중...`;
            
            if (moveTimer) clearInterval(moveTimer);
            moveTimer = setInterval(() => {
                stimulus.distPercent -= 4; // 1.2초마다 4%씩 이동 (항상 일정한 속도감)
                draw();
                if (stimulus.distPercent <= 2) recordPoint(true);
            }, 1200);
        }

        function recordPoint(failed = false) {
            clearInterval(moveTimer);
            const pid = focusPoints[currentPIdx].id;
            if (!results.data[pid]) results.data[pid] = {};
            results.data[pid][angles[currentAngleIdx]] = failed ? "Blind" : stimulus.distPercent.toFixed(1);
            
            stimulus.active = false;
            currentAngleIdx++;
            draw();
            setTimeout(nextStep, 800);
        }

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && stimulus.active) {
                e.preventDefault(); recordPoint(false);
            }
        });

        function copyData() {
            navigator.clipboard.writeText(JSON.stringify(results, null, 2));
            alert("환경 데이터가 포함된 JSON이 복사되었습니다.");
        }
    </script>
</body>
</html>
